<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#18181b">
  <title>Mandala Planner</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fafafa;
      --bg-card: #ffffff;
      --bg-muted: #f4f4f5;
      --bg-hover: #ebebeb;
      --text: #18181b;
      --text-secondary: #52525b;
      --text-muted: #a1a1aa;
      --border: #e4e4e7;
      --accent: #18181b;
      --success: #16a34a;
      --warning: #ca8a04;
      --danger: #dc2626;
      --radius-sm: 8px;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', 'Noto Sans JP', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      overscroll-behavior: none;
    }

    /* Header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 40;
    }
    .header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 13px;
    }
    .brand-text {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }
    .nav {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn {
      height: 34px;
      padding: 0 12px;
      font-size: 13px;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: inherit;
    }
    .btn:hover { background: var(--bg-muted); }
    .btn-icon { width: 34px; padding: 0; justify-content: center; }
    .btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .btn-primary:hover { background: #27272a; }
    .btn-ghost { border-color: transparent; }
    .btn-danger { color: var(--danger); }
    .btn-danger:hover { background: #fef2f2; }
    .btn[disabled] { opacity: 0.4; cursor: not-allowed; }
    .btn svg { width: 15px; height: 15px; }
    .divider {
      width: 1px;
      height: 20px;
      background: var(--border);
      margin: 0 4px;
    }

    /* Main */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 20px;
    }
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 14px 0;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }

    /* Goal Hero */
    .goal-hero {
      background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
      border-radius: var(--radius);
      padding: 16px 20px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(24,24,27,0.2);
    }
    .goal-label {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.15em;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
    }
    .goal-text {
      font-size: 16px;
      font-weight: 700;
      color: white;
      letter-spacing: -0.02em;
      line-height: 1.4;
    }
    .goal-progress {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      margin-top: 6px;
    }
    .goal-progress span {
      font-size: 18px;
      font-weight: 700;
      color: #4ade80;
    }

    /* Mandala Grid */
    .mandala {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 100%;
      margin: 0 auto;
    }
    .block {
      border-radius: var(--radius);
      overflow: hidden;
      border: 3px solid;
      transition: box-shadow var(--transition);
    }
    .block:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .block-inner {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      padding: 2px;
    }
    .cell {
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .cell-btn {
      width: 100%;
      height: 100%;
      border: none;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
      cursor: pointer;
      transition: transform var(--transition);
      font-family: inherit;
    }
    .cell-btn:hover { transform: scale(1.02); }
    .cell-name {
      font-size: clamp(7px, 1.1vw, 11px);
      font-weight: 500;
      line-height: 1.3;
      text-align: center;
      color: var(--text);
      white-space: pre-line;
      word-break: keep-all;
    }
    .cell-pct {
      font-size: 8px;
      font-weight: 600;
      margin-top: 2px;
      opacity: 0.7;
    }
    .cell-center {
      background: var(--accent) !important;
    }
    .cell-center .cell-name {
      color: white;
      font-size: clamp(8px, 1.2vw, 12px);
      font-weight: 600;
    }
    .cell-center .cell-pct { color: rgba(255,255,255,0.8); }
    .cell-cat .cell-name {
      color: white;
      font-weight: 600;
    }
    .cell-cat .cell-pct { color: rgba(255,255,255,0.8); }
    .badge {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      font-size: 6px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .badge-danger { background: var(--danger); color: white; }
    .badge-warning { background: var(--warning); color: white; }
    .badge-info { background: #3b82f6; color: white; }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
      animation: fadeIn 150ms ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slideUp 200ms ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    .modal-lg { max-width: 560px; }
    .modal-xl { max-width: 640px; }
    .modal-head {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .modal-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .modal-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
    }
    .modal-close:hover { background: var(--bg-muted); color: var(--text); }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-foot {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      background: var(--bg-muted);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Forms */
    .field { margin-bottom: 16px; }
    .label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .input {
      width: 100%;
      height: 38px;
      padding: 0 12px;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text);
      font-family: inherit;
      transition: all var(--transition);
    }
    .input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(24,24,27,0.06);
    }
    .input::placeholder { color: var(--text-muted); }
    textarea.input {
      height: auto;
      min-height: 72px;
      padding: 10px 12px;
      resize: vertical;
    }
    select.input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%23a1a1aa' stroke-width='2'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 32px;
    }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }

    /* Task list */
    .tasks { list-style: none; }
    .task {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: var(--bg-muted);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
    }
    .task:hover { background: var(--bg-hover); }
    .task-check {
      width: 16px;
      height: 16px;
      margin-top: 2px;
      accent-color: var(--accent);
    }
    .task-body { flex: 1; min-width: 0; }
    .task-name {
      font-size: 13px;
      font-weight: 500;
    }
    .task-name.done {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .task-meta {
      display: flex;
      gap: 10px;
      margin-top: 3px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .task-del {
      padding: 4px 6px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all var(--transition);
    }
    .task-del:hover { background: #fef2f2; color: var(--danger); }
    .task-del svg { pointer-events: none; }
    .priority { display: flex; align-items: center; gap: 3px; }
    .priority-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }
    .p-high .priority-dot { background: var(--danger); }
    .p-med .priority-dot { background: var(--warning); }
    .p-low .priority-dot { background: var(--text-muted); }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat {
      background: var(--bg-muted);
      border-radius: var(--radius-sm);
      padding: 14px 12px;
      text-align: center;
    }
    .stat-val {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 2px;
    }
    .stat-danger { background: #fef2f2; }
    .stat-danger .stat-val { color: var(--danger); }
    .stat-warning { background: #fefce8; }
    .stat-warning .stat-val { color: var(--warning); }
    .stat-info { background: #eff6ff; }
    .stat-info .stat-val { color: #2563eb; }
    .stat-success { background: #f0fdf4; }
    .stat-success .stat-val { color: var(--success); }

    /* Section */
    .section { margin-bottom: 20px; }
    .section-head {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .section-badge {
      font-size: 10px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 100px;
      background: var(--bg-muted);
      color: var(--text-muted);
    }

    /* Progress bar */
    .progress {
      height: 5px;
      background: var(--bg-muted);
      border-radius: 100px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      border-radius: 100px;
      transition: width 400ms ease;
    }

    /* Chips */
    .chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .chip-label {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      margin-right: 2px;
    }
    .chip {
      height: 28px;
      padding: 0 11px;
      font-size: 11px;
      font-weight: 500;
      border-radius: 100px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition);
      font-family: inherit;
    }
    .chip:hover { background: var(--bg-muted); }
    .chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Color picker */
    .colors {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .color-btn {
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all var(--transition);
    }
    .color-btn:hover { transform: scale(1.08); }
    .color-btn.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent);
    }
    .color-custom {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .color-input {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }
    .color-preview {
      height: 48px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 14px;
    }

    /* Element card */
    .el-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-bottom: 10px;
    }
    .el-head {
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background var(--transition);
    }
    .el-head:hover { background: rgba(0,0,0,0.02); }
    .el-name { font-size: 13px; font-weight: 600; }
    .el-pct { font-size: 11px; color: var(--text-muted); }
    .el-memo {
      padding: 8px 12px;
      background: var(--bg-muted);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }
    .el-tasks {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .mini-task {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      font-size: 12px;
    }
    .mini-check { width: 13px; height: 13px; }

    /* Matrix */
    .matrix {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .quadrant {
      border-radius: var(--radius);
      padding: 14px;
      min-height: 140px;
    }
    .quadrant-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .quadrant-title { font-size: 12px; font-weight: 600; }
    .quadrant-count {
      font-size: 10px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 100px;
      color: white;
    }
    .quadrant-sub { font-size: 10px; opacity: 0.7; margin-bottom: 8px; }
    .q1 { background: #fef2f2; }
    .q1 .quadrant-title { color: #991b1b; }
    .q1 .quadrant-count { background: var(--danger); }
    .q2 { background: #eff6ff; }
    .q2 .quadrant-title { color: #1e40af; }
    .q2 .quadrant-count { background: #2563eb; }
    .q3 { background: #fefce8; }
    .q3 .quadrant-title { color: #854d0e; }
    .q3 .quadrant-count { background: var(--warning); }
    .q4 { background: var(--bg-muted); }
    .q4 .quadrant-title { color: var(--text-secondary); }
    .q4 .quadrant-count { background: var(--text-muted); }

    /* Milestone */
    .milestone {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-muted);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
    }
    .milestone.done { background: #f0fdf4; }
    .milestone-name { flex: 1; font-size: 13px; font-weight: 500; }
    .milestone-name.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* History */
    .history-month {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .history-month:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .history-month-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .history-month-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .history-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-muted);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
    }
    .history-milestone {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }
    .history-icon {
      font-size: 12px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .history-content {
      flex: 1;
      min-width: 0;
    }
    .history-title {
      font-size: 13px;
      font-weight: 500;
      display: block;
    }
    .history-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-top: 2px;
    }
    .history-date {
      font-size: 11px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* Empty */
    .empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
    }
    .empty-icon { font-size: 24px; margin-bottom: 6px; }
    .empty-text { font-size: 13px; }

    /* Responsive */
    @media (max-width: 768px) {
      .header-inner {
        padding: 10px 12px;
      }
      .brand-text { font-size: 14px; }
      .brand-sub { font-size: 10px; }
      .brand-icon { width: 28px; height: 28px; font-size: 11px; }
      .nav {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 4px;
      }
      .btn {
        height: 32px;
        padding: 0 10px;
        font-size: 12px;
      }
      .btn-icon { width: 32px; }
      .divider { display: none; }
      .main { padding: 12px 8px; }
      .card { padding: 12px; border-radius: var(--radius); }
      .goal-hero {
        padding: 12px 14px;
        margin-bottom: 12px;
      }
      .goal-label { font-size: 8px; margin-bottom: 2px; }
      .goal-text { font-size: 14px; }
      .goal-progress { font-size: 10px; margin-top: 4px; }
      .goal-progress span { font-size: 16px; }
      .mandala { gap: 4px; }
      .block { border-width: 2px; border-radius: var(--radius-sm); }
      .block-inner { gap: 1px; padding: 1px; }
      .cell { border-radius: 4px; }
      .cell-btn { padding: 2px; }
      .cell-name { font-size: clamp(6px, 2.2vw, 10px); }
      .cell-pct { font-size: 6px; }
      .cell-center .cell-name { font-size: clamp(7px, 2.5vw, 11px); }
      .badge { width: 9px; height: 9px; font-size: 5px; top: 1px; right: 1px; }
      .legend { 
        gap: 12px; 
        padding: 10px 0;
        margin-top: 12px;
      }
      .legend-item { font-size: 9px; gap: 4px; }
      .legend-dot { width: 8px; height: 8px; }
      
      /* Modal mobile */
      .overlay { padding: 8px; }
      .modal {
        max-height: 90vh;
        border-radius: var(--radius);
      }
      .modal-head { padding: 12px 14px; }
      .modal-title { font-size: 14px; }
      .modal-sub { font-size: 11px; }
      .modal-body { padding: 14px; }
      .modal-foot { padding: 12px 14px; }
      .modal-close { width: 26px; height: 26px; }
      
      /* Form mobile */
      .field { margin-bottom: 12px; }
      .label { font-size: 11px; margin-bottom: 4px; }
      .input { height: 36px; padding: 0 10px; font-size: 14px; }
      textarea.input { padding: 8px 10px; min-height: 60px; }
      .row { flex-direction: column; gap: 8px; }
      
      /* Task mobile */
      .task { padding: 10px; gap: 8px; }
      .task-check { width: 18px; height: 18px; }
      .task-name { font-size: 13px; }
      .task-meta { font-size: 10px; gap: 6px; margin-top: 2px; }
      .task-del { padding: 6px 8px; }
      
      /* Stats mobile */
      .stats { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .stat { padding: 10px 8px; }
      .stat-val { font-size: 18px; }
      .stat-label { font-size: 8px; }
      
      /* Section mobile */
      .section { margin-bottom: 16px; }
      .section-title { font-size: 11px; }
      .section-badge { font-size: 9px; padding: 1px 6px; }
      
      /* Chips mobile */
      .chips { gap: 4px; margin-bottom: 10px; }
      .chip { height: 26px; padding: 0 9px; font-size: 10px; }
      .chip-label { font-size: 10px; }
      
      /* Matrix mobile */
      .matrix { grid-template-columns: 1fr; gap: 8px; }
      .quadrant { min-height: 100px; padding: 12px; }
      .quadrant-title { font-size: 11px; }
      .quadrant-count { font-size: 9px; padding: 1px 6px; }
      .quadrant-sub { font-size: 9px; }
      
      /* Element card mobile */
      .el-card { margin-bottom: 8px; }
      .el-head { padding: 8px 10px; }
      .el-name { font-size: 12px; }
      .el-pct { font-size: 10px; }
      .el-memo { padding: 6px 10px; font-size: 11px; }
      .el-tasks { padding: 6px 10px; }
      .mini-task { font-size: 11px; padding: 3px 0; }
      .mini-check { width: 14px; height: 14px; }
      
      /* Color picker mobile */
      .colors { grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .color-btn { border-radius: 6px; }
      .color-preview { height: 40px; font-size: 12px; }
      .color-input { width: 36px; height: 36px; }
      
      /* Milestone mobile */
      .milestone { padding: 8px 10px; gap: 8px; }
      .milestone-name { font-size: 12px; }
      
      /* Progress mobile */
      .progress { height: 4px; }
    }
    
    /* Extra small screens */
    @media (max-width: 380px) {
      .nav .btn span { display: none; }
      .nav .btn { width: 32px; padding: 0; justify-content: center; }
      .nav .btn::before { content: attr(data-icon); }
      .goal-text { font-size: 12px; }
      .cell-name { font-size: clamp(5px, 2vw, 8px); }
    }
    
    /* Touch device improvements */
    @media (hover: none) and (pointer: coarse) {
      .cell-btn:hover { transform: none; }
      .block:hover { box-shadow: var(--shadow); }
      .btn:active { transform: scale(0.97); }
      .cell-btn:active { transform: scale(0.95); }
      .task:active { background: var(--bg-hover); }
    }
    
    /* Safe area for notched iPhones */
    @supports (padding: max(0px)) {
      .header {
        padding-top: max(0px, env(safe-area-inset-top));
      }
      .main {
        padding-left: max(8px, env(safe-area-inset-left));
        padding-right: max(8px, env(safe-area-inset-right));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }
      .modal {
        margin-bottom: max(0px, env(safe-area-inset-bottom));
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 100px; }

    /* Auth Screen */
    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg);
    }
    .auth-card {
      width: 100%;
      max-width: 380px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 32px 28px;
    }
    .auth-logo {
      width: 56px;
      height: 56px;
      background: var(--accent);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 22px;
      margin: 0 auto 16px;
    }
    .auth-title {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 4px;
    }
    .auth-sub {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 24px;
    }
    .auth-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .auth-input {
      width: 100%;
      height: 44px;
      padding: 0 14px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text);
      font-family: inherit;
      margin-bottom: 12px;
      transition: all var(--transition);
    }
    .auth-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(24,24,27,0.06);
    }
    .auth-btn {
      width: 100%;
      height: 44px;
      font-size: 14px;
      font-weight: 600;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .auth-btn:hover { background: var(--bg-muted); }
    .auth-btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .auth-btn-primary:hover { background: #27272a; }
    .auth-btn-google {
      background: white;
      border: 1px solid #dadce0;
    }
    .auth-btn-google:hover { background: #f8f9fa; }
    .auth-btn svg { width: 18px; height: 18px; }
    .auth-error {
      background: #fef2f2;
      color: var(--danger);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      margin-bottom: 12px;
      display: none;
    }
    .auth-error.show { display: block; }
    .auth-toggle {
      text-align: center;
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .auth-toggle a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .auth-toggle a:hover { text-decoration: underline; }
    .auth-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
    }
    .auth-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sync-status {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sync-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
    }
    .sync-dot.syncing {
      background: var(--warning);
      animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .user-menu {
      position: relative;
    }
    .user-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-muted);
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      overflow: hidden;
    }
    .user-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      min-width: 180px;
      padding: 8px;
      display: none;
      z-index: 50;
    }
    .user-dropdown.show { display: block; }
    .user-info {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .user-name {
      font-size: 13px;
      font-weight: 600;
    }
    .user-email {
      font-size: 11px;
      color: var(--text-muted);
    }
    .user-dropdown-item {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border: none;
      background: none;
      color: var(--text);
      text-align: left;
      cursor: pointer;
      border-radius: 4px;
      font-family: inherit;
    }
    .user-dropdown-item:hover { background: var(--bg-muted); }
    .user-dropdown-item.danger { color: var(--danger); }
  </style>
</head>
<body>
<div id="app"></div>
<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyCaVNjz81FdNVXplhS39Q2pPi9n1HqsC3Y",
  authDomain: "mandala-planner.firebaseapp.com",
  projectId: "mandala-planner",
  storageBucket: "mandala-planner.firebasestorage.app",
  messagingSenderId: "748155948120",
  appId: "1:748155948120:web:e3b5bb4972aea01b714e2d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ===== Auth State =====
var currentUser = null;
var authMode = 'login'; // 'login' or 'register'
var authLoading = true;
var syncing = false;

// Google Icon SVG
var googleIcon = '<svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>';

// „Ç¢„Éó„É™ÂÜÖ„Éñ„É©„Ç¶„Ç∂Ê§úÂá∫
function isInAppBrowser() {
  var ua = navigator.userAgent || navigator.vendor || window.opera;
  // LINE, Facebook, Instagram, Twitter, „Åù„ÅÆ‰ªñ„ÅÆ„Ç¢„Éó„É™ÂÜÖ„Éñ„É©„Ç¶„Ç∂„ÇíÊ§úÂá∫
  return /FBAN|FBAV|Instagram|Line|Twitter|MicroMessenger|WebView/i.test(ua) || 
         (ua.includes('iPhone') && !ua.includes('Safari')) ||
         (ua.includes('Android') && ua.includes('wv'));
}

var inAppBrowser = isInAppBrowser();

// ===== Auth Functions =====
function renderAuthScreen() {
  if (authLoading) {
    return '<div class="auth-screen"><div class="auth-loading"><div class="auth-spinner"></div><span style="color:var(--text-muted);font-size:13px">Ë™≠„ÅøËæº„Åø‰∏≠...</span></div></div>';
  }
  
  var h = '<div class="auth-screen"><div class="auth-card">';
  h += '<div class="auth-logo">M</div>';
  h += '<h1 class="auth-title">Mandala Planner</h1>';
  h += '<p class="auth-sub">' + (authMode === 'login' ? '„É≠„Ç∞„Ç§„É≥„Åó„Å¶Âßã„ÇÅ„Çã' : 'Êñ∞Ë¶è„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê') + '</p>';
  
  h += '<div id="authError" class="auth-error"></div>';
  
  // „Ç¢„Éó„É™ÂÜÖ„Éñ„É©„Ç¶„Ç∂„ÅÆË≠¶Âëä
  if (inAppBrowser) {
    h += '<div style="background:#fef3c7;color:#92400e;padding:12px;border-radius:8px;font-size:12px;margin-bottom:16px;line-height:1.5">';
    h += '<strong>‚ö†Ô∏è „Ç¢„Éó„É™ÂÜÖ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØ‰∏ÄÈÉ®Ê©üËÉΩ„ÅåÂà∂Èôê„Åï„Çå„Åæ„Åô</strong><br>';
    h += 'Safari„Åæ„Åü„ÅØChrome„ÅßÈñã„Åè„Åì„Å®„Çí„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô„ÄÇ<br>';
    h += '<button onclick="copyURL()" style="margin-top:8px;padding:6px 12px;background:#92400e;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer">URL„Çí„Ç≥„Éî„Éº</button>';
    h += '</div>';
  }
  
  h += '<button class="auth-btn auth-btn-google" onclick="signInWithGoogle()">' + googleIcon + 'Google„Åß„É≠„Ç∞„Ç§„É≥</button>';
  
  h += '<div class="auth-divider">„Åæ„Åü„ÅØ</div>';
  
  h += '<input type="email" id="authEmail" class="auth-input" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">';
  h += '<input type="password" id="authPassword" class="auth-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">';
  
  if (authMode === 'login') {
    h += '<button class="auth-btn auth-btn-primary" onclick="signInWithEmail()">„É≠„Ç∞„Ç§„É≥</button>';
    h += '<div class="auth-toggle">„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÊñπ <a href="#" onclick="toggleAuthMode();return false;">Êñ∞Ë¶èÁôªÈå≤</a></div>';
  } else {
    h += '<button class="auth-btn auth-btn-primary" onclick="registerWithEmail()">ÁôªÈå≤</button>';
    h += '<div class="auth-toggle">Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ <a href="#" onclick="toggleAuthMode();return false;">„É≠„Ç∞„Ç§„É≥</a></div>';
  }
  
  h += '</div></div>';
  return h;
}

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'register' : 'login';
  document.getElementById('app').innerHTML = renderAuthScreen();
}

function showAuthError(msg) {
  var el = document.getElementById('authError');
  if (el) {
    el.textContent = msg;
    el.classList.add('show');
  }
}

function copyURL() {
  navigator.clipboard.writeText(window.location.href).then(function() {
    alert('URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇSafari„Åæ„Åü„ÅØChrome„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  }).catch(function() {
    prompt('‰ª•‰∏ã„ÅÆURL„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', window.location.href);
  });
}

async function signInWithGoogle() {
  try {
    var provider = new firebase.auth.GoogleAuthProvider();
    // „É¢„Éê„Ç§„É´„ÅØ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„ÄÅPC„ÅØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè
    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
      await auth.signInWithRedirect(provider);
    } else {
      await auth.signInWithPopup(provider);
    }
  } catch (e) {
    console.error(e);
    showAuthError('Google„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
  }
}

async function signInWithEmail() {
  var email = document.getElementById('authEmail').value.trim();
  var password = document.getElementById('authPassword').value;
  
  if (!email || !password) {
    showAuthError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (e) {
    console.error(e);
    var msg = '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
    if (e.code === 'auth/user-not-found') msg = '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
    if (e.code === 'auth/wrong-password') msg = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô';
    if (e.code === 'auth/invalid-email') msg = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
    showAuthError(msg);
  }
}

async function registerWithEmail() {
  var email = document.getElementById('authEmail').value.trim();
  var password = document.getElementById('authPassword').value;
  
  if (!email || !password) {
    showAuthError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  if (password.length < 6) {
    showAuthError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  try {
    await auth.createUserWithEmailAndPassword(email, password);
  } catch (e) {
    console.error(e);
    var msg = 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
    if (e.code === 'auth/email-already-in-use') msg = '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô';
    if (e.code === 'auth/invalid-email') msg = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
    if (e.code === 'auth/weak-password') msg = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂº±„Åô„Åé„Åæ„Åô';
    showAuthError(msg);
  }
}

async function signOut() {
  try {
    await auth.signOut();
  } catch (e) {
    console.error(e);
  }
}

// ===== Cloud Save/Load =====
async function loadFromCloud() {
  if (!currentUser) return false;
  
  try {
    var doc = await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
      var data = doc.data();
      if (data.mandalaData) S.data = data.mandalaData;
      if (data.colors) S.colors = data.colors;
      if (data.centerColor) S.centerColor = data.centerColor;
      if (data.milestones) S.milestones = data.milestones;
      return true;
    }
  } catch (e) {
    console.error('Cloud load error:', e);
  }
  return false;
}

async function saveToCloud() {
  if (!currentUser) return;
  
  syncing = true;
  updateSyncStatus();
  
  try {
    await db.collection('users').doc(currentUser.uid).set({
      mandalaData: S.data,
      colors: S.colors,
      centerColor: S.centerColor,
      milestones: S.milestones,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (e) {
    console.error('Cloud save error:', e);
  }
  
  syncing = false;
  updateSyncStatus();
}

function updateSyncStatus() {
  var el = document.querySelector('.sync-status');
  if (el) {
    var dot = el.querySelector('.sync-dot');
    if (dot) {
      dot.className = syncing ? 'sync-dot syncing' : 'sync-dot';
    }
  }
}

// Debounced save
var saveTimer = null;
function debouncedCloudSave() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveToCloud, 1000);
}

// ===== Icons =====
var I = {
  undo: '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h7M3 10l4-4M3 10l4 4"/><path d="M21 14a7 7 0 1 0-7-7"/></svg>',
  x: '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>',
  trash: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14"/></svg>',
  plus: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>'
};

// ===== Data =====
var defaultColors = [
  {bg:'#fef3c7',border:'#d97706',center:'#d97706'},
  {bg:'#fce7f3',border:'#db2777',center:'#db2777'},
  {bg:'#e0e7ff',border:'#4f46e5',center:'#4f46e5'},
  {bg:'#d1fae5',border:'#059669',center:'#059669'},
  {bg:'#e0f2fe',border:'#0284c7',center:'#0284c7'},
  {bg:'#fae8ff',border:'#c026d3',center:'#c026d3'},
  {bg:'#ffedd5',border:'#ea580c',center:'#ea580c'},
  {bg:'#f1f5f9',border:'#475569',center:'#475569'}
];
var defaultCenter = {bg:'#18181b',border:'#18181b',center:'#18181b'};
var presets = [
  {n:'Amber',c:'#d97706',bg:'#fef3c7'},{n:'Rose',c:'#e11d48',bg:'#ffe4e6'},
  {n:'Indigo',c:'#4f46e5',bg:'#e0e7ff'},{n:'Emerald',c:'#059669',bg:'#d1fae5'},
  {n:'Sky',c:'#0284c7',bg:'#e0f2fe'},{n:'Fuchsia',c:'#c026d3',bg:'#fae8ff'},
  {n:'Orange',c:'#ea580c',bg:'#ffedd5'},{n:'Slate',c:'#475569',bg:'#f1f5f9'},
  {n:'Red',c:'#dc2626',bg:'#fee2e2'},{n:'Teal',c:'#0d9488',bg:'#ccfbf1'},
  {n:'Violet',c:'#7c3aed',bg:'#ede9fe'},{n:'Pink',c:'#db2777',bg:'#fce7f3'}
];

function makeEls(ci,names,ti,tasks){
  var r=[];
  for(var i=0;i<names.length;i++){
    r.push({id:'el-'+ci+'-'+i,name:names[i],memo:'',tasks:i===ti?tasks:[]});
  }
  return r;
}

function sampleData(){
  return {
    centerGoal:'2026Âπ¥ Â£≤‰∏ä1ÂÑÑÂÜÜÈÅîÊàê',
    categories:[
      {id:'cat-0',name:'Êñ∞Ë¶èÈ°ßÂÆ¢Áç≤Âæó',elements:makeEls(0,['„É™„Éº„ÉâÁç≤ÂæóÊñΩÁ≠ñ','Âñ∂Ê•≠„Éó„É≠„Çª„ÇπÊîπÂñÑ','WebÈõÜÂÆ¢Âº∑Âåñ','Â±ïÁ§∫‰ºöÂá∫Â±ï','Á¥π‰ªãÂà∂Â∫¶ÊßãÁØâ','„Çø„Éº„Ç≤„ÉÉ„ÉàÂàÜÊûê','ÊèêÊ°àË≥áÊñôÂà∑Êñ∞','CRMÂ∞éÂÖ•'],2,[
        {id:'t1',title:'SEOÂØæÁ≠ñ„Ç≠„Éº„ÉØ„Éº„ÉâÈÅ∏ÂÆö',priority:'high',dueDate:'2026-01-31',completed:true},
        {id:'t2',title:'„Éñ„É≠„Ç∞Ë®ò‰∫ã10Êú¨‰ΩúÊàê',priority:'medium',dueDate:'2026-03-31',completed:false},
        {id:'t3',title:'LPÊîπÂñÑA/B„ÉÜ„Çπ„ÉàÂÆüÊñΩ',priority:'high',dueDate:'2026-02-15',completed:false}
      ])},
      {id:'cat-1',name:'Êó¢Â≠òÈ°ßÂÆ¢Á∂≠ÊåÅ',elements:makeEls(1,['È°ßÂÆ¢Ê∫ÄË∂≥Â∫¶Ë™øÊüª','ÂÆöÊúü„Éï„Ç©„É≠„Éº‰ΩìÂà∂','„É≠„Ç§„É§„É´„ÉÜ„Ç£ÊñΩÁ≠ñ','„ÇØ„É¨„Éº„É†ÂØæÂøúÊîπÂñÑ','„Ç¢„ÉÉ„Éó„Çª„É´ÊèêÊ°à','È°ßÂÆ¢DBÊï¥ÂÇô','„Éã„É•„Éº„Çπ„É¨„Çø„Éº','VIPÈ°ßÂÆ¢ÂØæÂøú'],-1,[])},
      {id:'cat-2',name:'ÂïÜÂìÅÈñãÁô∫',elements:makeEls(2,['Â∏ÇÂ†¥Ë™øÊüªÂÆüÊñΩ','Á´∂ÂêàÂàÜÊûê','Êñ∞ÂïÜÂìÅ‰ºÅÁîª','„Éó„É≠„Éà„Çø„Ç§„Éó‰ΩúÊàê','„ÉÜ„Çπ„ÉàË≤©Â£≤','‰æ°Ê†ºÊà¶Áï•Á≠ñÂÆö','„Éë„ÉÉ„Ç±„Éº„Ç∏Âà∑Êñ∞','ÂìÅË≥™ÁÆ°ÁêÜÂº∑Âåñ'],-1,[])},
      {id:'cat-3',name:'„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞',elements:makeEls(3,['SNSÈÅãÁî®Âº∑Âåñ','„Ç≥„É≥„ÉÜ„É≥„ÉÑÂà∂‰Ωú','Â∫ÉÂëäÈÅãÁî®ÊúÄÈÅ©Âåñ','PRÊ¥ªÂãï','„Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞','„Ç§„Éô„É≥„Éà‰ºÅÁîª','ÂãïÁîª„Éû„Éº„Ç±','„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº'],0,[
        {id:'t4',title:'ÊäïÁ®ø„Ç´„É¨„É≥„ÉÄ„Éº‰ΩúÊàê',priority:'medium',dueDate:'2026-01-15',completed:true},
        {id:'t5',title:'„Ç§„É≥„Çπ„ÇøÊØéÊó•ÊäïÁ®ø',priority:'high',dueDate:'2026-12-31',completed:false}
      ])},
      {id:'cat-4',name:'Ê•≠ÂãôÂäπÁéáÂåñ',elements:makeEls(4,['Ê•≠Âãô„Éï„É≠„ÉºË¶ãÁõ¥„Åó','„ÉÑ„Éº„É´Â∞éÂÖ•','Ëá™ÂãïÂåñÊé®ÈÄ≤','‰ºöË≠∞ÊôÇÈñìÂâäÊ∏õ','„Éö„Éº„Éë„Éº„É¨„ÇπÂåñ','Â§ñÊ≥®Ê¥ªÁî®','„Éû„Éã„É•„Ç¢„É´Êï¥ÂÇô','KPIÁÆ°ÁêÜ'],-1,[])},
      {id:'cat-5',name:'‰∫∫ÊùêËÇ≤Êàê',elements:makeEls(5,['Á†î‰øÆÂà∂Â∫¶ÊßãÁØâ','OJTÂº∑Âåñ','Ë©ï‰æ°Âà∂Â∫¶ÊîπÂñÑ','1on1ÂÆüÊñΩ','„Çπ„Ç≠„É´„Éû„ÉÉ„Éó','Êé°Áî®Âº∑Âåñ','„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥','„É™„Éº„ÉÄ„ÉºËÇ≤Êàê'],0,[
        {id:'t6',title:'Á†î‰øÆ„Ç´„É™„Ç≠„É•„É©„É†Ë®≠Ë®à',priority:'high',dueDate:'2026-02-28',completed:true},
        {id:'t7',title:'Â§ñÈÉ®Ë¨õÂ∏´ÈÅ∏ÂÆö',priority:'medium',dueDate:'2026-03-15',completed:true},
        {id:'t8',title:'e„É©„Éº„Éã„É≥„Ç∞Â∞éÂÖ•',priority:'low',dueDate:'2026-06-30',completed:false}
      ])},
      {id:'cat-6',name:'Ë≤°ÂãôÁÆ°ÁêÜ',elements:makeEls(6,['‰∫àÁÆóÁÆ°ÁêÜÂæπÂ∫ï','„Ç≥„Çπ„ÉàÂâäÊ∏õ','„Ç≠„É£„ÉÉ„Ç∑„É•„Éï„É≠„Éº','ÊäïË≥áË®àÁîª','Á®éÂãôÂØæÁ≠ñ','Ë≥áÈáëË™øÈÅî','Ë≤°ÂãôÂàÜÊûê','„É™„Çπ„ÇØÁÆ°ÁêÜ'],-1,[])},
      {id:'cat-7',name:'„Éë„Éº„Éà„Éä„Éº',elements:makeEls(7,['ÊèêÊê∫ÂÖàÈñãÊãì','‰ª£ÁêÜÂ∫óÁ∂≤ÊßãÁØâ','ÂçîÊ•≠Ê°à‰ª∂ÂâµÂá∫','‰ªïÂÖ•ÂÖà‰∫§Ê∏â','Ê•≠ÁïåÂõ£‰ΩìÊ¥ªÂãï','Áï∞Ê•≠Á®Æ‰∫§ÊµÅ','M&AÊ§úË®é','Êµ∑Â§ñÂ±ïÈñã'],-1,[])}
    ]
  };
}

function emptyData(){
  var c=[];
  for(var i=0;i<8;i++){
    var e=[];
    for(var j=0;j<8;j++)e.push({id:'el-'+i+'-'+j,name:'',memo:'',tasks:[]});
    c.push({id:'cat-'+i,name:'',elements:e});
  }
  return {centerGoal:'',categories:c};
}

// ===== State =====
var S = {
  data:null,
  colors:JSON.parse(JSON.stringify(defaultColors)),
  centerColor:JSON.parse(JSON.stringify(defaultCenter)),
  editing:false,
  selEl:null,
  colorPicker:null,
  taskList:false,
  taskSort:'dueDate',
  taskFilter:'all',
  catMemo:null,
  today:false,
  review:false,
  matrix:false,
  history:false,
  milestones:[]
};
var histStack=[];

function saveHist(){
  histStack.push({
    data:JSON.parse(JSON.stringify(S.data)),
    colors:JSON.parse(JSON.stringify(S.colors)),
    centerColor:JSON.parse(JSON.stringify(S.centerColor))
  });
  if(histStack.length>20)histStack.shift();
}

function undo(){
  if(!histStack.length)return;
  var h=histStack.pop();
  S.data=h.data;S.colors=h.colors;S.centerColor=h.centerColor;
  save();render();
}

function load(){
  try{
    var d=localStorage.getItem('mandala-data');
    var c=localStorage.getItem('mandala-colors');
    var m=localStorage.getItem('mandala-milestones');
    S.data=d?JSON.parse(d):sampleData();
    if(c){var cc=JSON.parse(c);if(cc.blockColors)S.colors=cc.blockColors;if(cc.centerColor)S.centerColor=cc.centerColor;}
    if(m)S.milestones=JSON.parse(m);
  }catch(e){S.data=sampleData();}
}

function save(){
  try{
    localStorage.setItem('mandala-data',JSON.stringify(S.data));
    localStorage.setItem('mandala-colors',JSON.stringify({blockColors:S.colors,centerColor:S.centerColor}));
    localStorage.setItem('mandala-milestones',JSON.stringify(S.milestones));
    // Cloud save
    if (currentUser) {
      debouncedCloudSave();
    }
  }catch(e){}
}

// ===== Calc =====
function calcProg(t){
  if(!t||!t.length)return 0;
  var c=0;for(var i=0;i<t.length;i++)if(t[i].completed)c++;
  return Math.round(c/t.length*100);
}
function calcCatProg(cat){
  var t=0;for(var i=0;i<cat.elements.length;i++)t+=calcProg(cat.elements[i].tasks);
  return Math.round(t/8);
}
function progColor(p){
  if(p===0)return{bg:'#f4f4f5',text:'#71717a'};
  if(p<50)return{bg:'#fee2e2',text:'#991b1b'};
  if(p<100)return{bg:'#fef3c7',text:'#92400e'};
  return{bg:'#dcfce7',text:'#166534'};
}
function priStyle(p){
  if(p==='high')return{c:'#dc2626',l:'È´ò'};
  if(p==='medium')return{c:'#ca8a04',l:'‰∏≠'};
  return{c:'#71717a',l:'‰Ωé'};
}

var blockMap=[[0,1,2],[7,-1,3],[6,5,4]];
var elMap=[[0,1,2],[7,-1,3],[6,5,4]];

function getCell(r,c){
  var br=Math.floor(r/3),bc=Math.floor(c/3),ir=r%3,ic=c%3;
  var ci=blockMap[br][bc];
  if(br===1&&bc===1){
    if(ir===1&&ic===1)return{type:'center'};
    var x=elMap[ir][ic];if(x>=0)return{type:'cat',ci:x};
  }
  if(ci>=0){
    if(ir===1&&ic===1)return{type:'catBlock',ci:ci};
    var ei=elMap[ir][ic];if(ei>=0)return{type:'el',ci:ci,ei:ei};
  }
  return null;
}

// ===== Render =====
function renderUserMenu() {
  if (!currentUser) return '';
  var initial = currentUser.email ? currentUser.email.charAt(0).toUpperCase() : 'U';
  var photo = currentUser.photoURL;
  var h = '<div class="user-menu">';
  h += '<button class="user-btn" onclick="toggleUserDropdown()">';
  if (photo) {
    h += '<img src="' + photo + '" alt="">';
  } else {
    h += initial;
  }
  h += '</button>';
  h += '<div id="userDropdown" class="user-dropdown">';
  h += '<div class="user-info">';
  h += '<div class="user-name">' + (currentUser.displayName || '„É¶„Éº„Ç∂„Éº') + '</div>';
  h += '<div class="user-email">' + (currentUser.email || '') + '</div>';
  h += '</div>';
  h += '<button class="user-dropdown-item danger" onclick="signOut()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>';
  h += '</div></div>';
  return h;
}

function toggleUserDropdown() {
  var el = document.getElementById('userDropdown');
  if (el) el.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.user-menu')) {
    var el = document.getElementById('userDropdown');
    if (el) el.classList.remove('show');
  }
});

function render(){
  var app=document.getElementById('app');
  
  // Not logged in - show auth screen
  if (!currentUser) {
    app.innerHTML = renderAuthScreen();
    return;
  }
  
  var prog=0;
  for(var i=0;i<S.data.categories.length;i++)prog+=calcCatProg(S.data.categories[i]);
  prog=Math.round(prog/8);

  var h='';
  // Header
  h+='<header class="header"><div class="header-inner">';
  h+='<div class="brand"><div class="brand-icon">M</div><div><div class="brand-text">Mandala Planner</div><div class="brand-sub">ÈÅîÊàêÁéá '+prog+'%</div></div></div>';
  h+='<nav class="nav">';
  h+='<button class="btn btn-icon'+(histStack.length?'':' disabled')+'" onclick="undo()" title="Êàª„Åô">'+I.undo+'</button>';
  h+='<div class="divider"></div>';
  h+='<button class="btn" onclick="openToday()" data-icon="üìÖ"><span>‰ªäÊó•</span></button>';
  h+='<button class="btn" onclick="openReview()" data-icon="üìä"><span>ÈÄ≤Êçó</span></button>';
  h+='<button class="btn" onclick="openHistory()" data-icon="üìú"><span>Â±•Ê≠¥</span></button>';
  h+='<button class="btn" onclick="openMatrix()" data-icon="‚ö°"><span>ÂÑ™ÂÖàÂ∫¶</span></button>';
  h+='<button class="btn" onclick="openTasks()" data-icon="üìã"><span>‰∏ÄË¶ß</span></button>';
  h+='<div class="divider"></div>';
  h+='<button class="btn btn-ghost" onclick="loadSample()"><span>„Çµ„É≥„Éó„É´</span></button>';
  h+='<button class="btn btn-ghost btn-danger" onclick="resetAll()"><span>„É™„Çª„ÉÉ„Éà</span></button>';
  h+='<div class="divider"></div>';
  h+='<div class="sync-status"><span class="sync-dot"></span>ÂêåÊúü‰∏≠</div>';
  h+=renderUserMenu();
  h+='</nav></div></header>';

  // Main
  h+='<main class="main"><div class="card">';
  
  // ‰∏≠ÂøÉ„Ç¥„Éº„É´ÔºàÂ§ß„Åç„ÅèË°®Á§∫Ôºâ
  h+='<div class="goal-hero">';
  h+='<div class="goal-label">GOAL</div>';
  h+='<div class="goal-text">'+(S.data.centerGoal||'‰∏≠ÂøÉ„ÅÆÁõÆÊ®ô„Éû„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë®≠ÂÆö')+'</div>';
  h+='<div class="goal-progress"><span>'+prog+'%</span> ÈÅîÊàê</div>';
  h+='</div>';
  
  h+='<div class="mandala">'+renderMandala()+'</div>';
  h+='<div class="legend">';
  h+='<div class="legend-item"><div class="legend-dot" style="background:#f4f4f5"></div>0%</div>';
  h+='<div class="legend-item"><div class="legend-dot" style="background:#fee2e2"></div>1-49%</div>';
  h+='<div class="legend-item"><div class="legend-dot" style="background:#fef3c7"></div>50-99%</div>';
  h+='<div class="legend-item"><div class="legend-dot" style="background:#dcfce7"></div>100%</div>';
  h+='</div></div></main>';

  // Modals
  h+=renderColorPicker();
  h+=renderDetail();
  h+=renderTaskList();
  h+=renderCatMemo();
  h+=renderToday();
  h+=renderReviewModal();
  h+=renderHistoryModal();
  h+=renderMatrixModal();

  app.innerHTML=h;
}

function renderMandala(){
  var h='';
  for(var bi=0;bi<9;bi++){
    var br=Math.floor(bi/3),bc=bi%3;
    var ci=blockMap[br][bc];
    var col=ci===-1?S.centerColor:S.colors[ci];
    h+='<div class="block" style="border-color:'+col.border+';background:'+col.bg+'">';
    h+='<div class="block-inner">';
    for(var ci2=0;ci2<9;ci2++){
      var ir=Math.floor(ci2/3),ic=ci2%3;
      var gr=br*3+ir,gc=bc*3+ic;
      h+='<div class="cell">'+renderCell(gr,gc)+'</div>';
    }
    h+='</div></div>';
  }
  return h;
}

function renderCell(r,c){
  var cell=getCell(r,c);if(!cell)return'';
  var br=Math.floor(r/3),bc=Math.floor(c/3);
  var ci=blockMap[br][bc];
  var col=ci===-1?S.centerColor:S.colors[ci];

  if(cell.type==='center'){
    return '<button class="cell-btn cell-center" onclick="clickCenter()" style="background:'+S.centerColor.center+'"><span class="cell-name">'+(S.data.centerGoal||'ÁõÆÊ®ô„ÇíË®≠ÂÆö')+'</span></button>';
  }
  if(cell.type==='cat'){
    var cat=S.data.categories[cell.ci];
    var cc=S.colors[cell.ci];
    return '<button class="cell-btn cell-cat" onclick="clickCat('+cell.ci+')" style="background:'+cc.center+'"><span class="cell-name">'+(cat.name||'È†ÖÁõÆÂêç')+'</span></button>';
  }
  if(cell.type==='catBlock'){
    var cat=S.data.categories[cell.ci];
    var p=calcCatProg(cat);
    return '<button class="cell-btn cell-cat" onclick="openCatMemo('+cell.ci+')" ondblclick="event.stopPropagation();clickCat('+cell.ci+')" style="background:'+col.center+'"><span class="cell-name">'+(cat.name||'È†ÖÁõÆÂêç').replace(/\\n/g,'\n')+'</span><span class="cell-pct">'+p+'%</span></button>';
  }
  if(cell.type==='el'){
    var el=S.data.categories[cell.ci].elements[cell.ei];
    var p=calcProg(el.tasks);
    var pc=progColor(p);
    var pctH=el.tasks.length?'<span class="cell-pct" style="color:'+pc.text+'">'+p+'%</span>':'';
    var badge=getBadge(el);
    return '<button class="cell-btn" onclick="openEl('+cell.ci+','+cell.ei+')" style="background:'+pc.bg+'"><span class="cell-name" style="color:'+pc.text+'">'+(el.name||'Ë¶ÅÁ¥†')+'</span>'+pctH+'</button>'+badge;
  }
  return '';
}

function getBadge(el){
  var today=new Date().toISOString().split('T')[0];
  var overdue=false,high=false;
  for(var i=0;i<el.tasks.length;i++){
    var t=el.tasks[i];
    if(!t.completed){
      if(t.dueDate<today)overdue=true;
      if(t.priority==='high')high=true;
    }
  }
  if(overdue)return '<span class="badge badge-danger">!</span>';
  if(high)return '<span class="badge badge-warning">‚òÖ</span>';
  if(el.memo)return '<span class="badge badge-info">‚úé</span>';
  return '';
}

// ===== Color Picker =====
function renderColorPicker(){
  if(!S.colorPicker)return '';
  var isC=S.colorPicker.type==='center';
  var col=isC?S.centerColor:S.colors[S.colorPicker.idx];
  var title=isC?'‰∏≠ÂøÉÁõÆÊ®ô':(S.data.categories[S.colorPicker.idx]?S.data.categories[S.colorPicker.idx].name||'„Ç´„ÉÜ„Ç¥„É™':'„Ç´„ÉÜ„Ç¥„É™');
  var val=isC?S.data.centerGoal:(S.data.categories[S.colorPicker.idx]?S.data.categories[S.colorPicker.idx].name:'');

  var h='<div class="overlay" onclick="closeCP(event)"><div class="modal" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">'+title+'„ÇíÁ∑®ÈõÜ</div></div><button class="modal-close" onclick="closeCP()">'+I.x+'</button></div>';
  h+='<div class="modal-body">';
  h+='<div class="field"><label class="label">'+(isC?'ÁõÆÊ®ô':'ÂêçÂâç')+'</label>';
  if(isC)h+='<textarea class="input" id="cpText" placeholder="ÁõÆÊ®ô„ÇíÂÖ•Âäõ...">'+val+'</textarea>';
  else h+='<input class="input" id="cpText" value="'+val+'" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ...">';
  h+='</div>';
  h+='<div class="field"><label class="label">„Ç´„É©„Éº</label><div class="colors">';
  for(var i=0;i<presets.length;i++){
    var p=presets[i];
    h+='<button class="color-btn'+(col.center===p.c?' selected':'')+'" onclick="pickColor('+i+')" style="background:'+p.c+'" title="'+p.n+'"></button>';
  }
  h+='</div></div>';
  h+='<div class="field"><label class="label">„Ç´„Çπ„Çø„É†</label><div class="color-custom"><input type="color" class="color-input" id="customCol" value="'+col.center+'" onchange="customColor(this.value)"><span style="font-family:monospace;color:var(--text-muted);font-size:12px">'+col.center+'</span></div></div>';
  h+='<div class="color-preview" style="background:'+col.center+'">'+title+'</div>';
  h+='</div><div class="modal-foot"><button class="btn" onclick="closeCP()">„Ç≠„É£„É≥„Çª„É´</button><button class="btn btn-primary" onclick="saveCP()">‰øùÂ≠ò</button></div></div></div>';
  return h;
}

function clickCenter(){openCP('center');}
function clickCat(i){openCP('cat',i);}
function openCP(type,idx){saveHist();S.colorPicker={type:type,idx:idx};render();}
function closeCP(e){if(e&&e.target!==e.currentTarget)return;S.colorPicker=null;render();}
function pickColor(i){applyColor(presets[i].c,presets[i].bg);}
function customColor(c){applyColor(c,c+'20');}
function applyColor(c,bg){
  if(S.colorPicker.type==='center'){S.centerColor={bg:bg,border:c,center:c};}
  else{S.colors[S.colorPicker.idx]={bg:bg,border:c,center:c};}
  save();render();
}
function saveCP(){
  var v=document.getElementById('cpText').value;
  if(S.colorPicker.type==='center')S.data.centerGoal=v;
  else S.data.categories[S.colorPicker.idx].name=v;
  save();S.colorPicker=null;render();
}

// ===== Element Detail =====
function renderDetail(){
  if(!S.selEl)return '';
  var ci=S.selEl.ci,ei=S.selEl.ei;
  var el=S.data.categories[ci].elements[ei];
  var p=calcProg(el.tasks);
  var pc=progColor(p);
  var done=el.tasks.filter(function(t){return t.completed}).length;
  var today=new Date().toISOString().split('T')[0];

  var tasks='';
  if(!el.tasks.length){
    tasks='<div class="empty"><div class="empty-text">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
  }else{
    tasks='<ul class="tasks">';
    for(var i=0;i<el.tasks.length;i++){
      var t=el.tasks[i];
      var ps=priStyle(t.priority);
      var od=!t.completed&&t.dueDate<today;
      tasks+='<li class="task"><input type="checkbox" class="task-check"'+(t.completed?' checked':'')+' onchange="toggleTask(\''+el.id+'\',\''+t.id+'\')"><div class="task-body"><div class="task-name'+(t.completed?' done':'')+'">'+t.title+'</div><div class="task-meta"><span class="priority p-'+t.priority+'"><span class="priority-dot"></span>'+ps.l+'</span><span style="'+(od?'color:var(--danger)':'')+'">'+t.dueDate+'</span></div></div><button type="button" class="task-del" onclick="event.stopPropagation();delTask(\''+el.id+'\',\''+t.id+'\')">'+I.trash+'</button></li>';
    }
    tasks+='</ul>';
  }

  var h='<div class="overlay" onclick="closeEl(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head" style="background:'+pc.bg+'"><div style="flex:1">';
  h+='<input class="input" id="elName" value="'+(el.name||'')+'" onchange="saveElName('+ci+','+ei+',this.value)" style="font-weight:600;margin-bottom:4px;background:transparent;border-color:'+pc.text+'40" placeholder="Ë¶ÅÁ¥†Âêç...">';
  h+='<div class="modal-sub" style="color:'+pc.text+'">'+p+'% ('+done+'/'+el.tasks.length+')</div></div>';
  h+='<button class="modal-close" onclick="closeEl()">'+I.x+'</button></div>';
  h+='<div class="modal-body">';
  h+='<div class="field"><label class="label">„É°„É¢</label><textarea class="input" id="elMemo" onchange="saveElMemo('+ci+','+ei+',this.value)" placeholder="„É°„É¢„ÇíÂÖ•Âäõ...">'+(el.memo||'')+'</textarea></div>';
  h+='<div class="section"><div class="section-head"><span class="section-title">„Çø„Çπ„ÇØ</span><span class="section-badge">'+el.tasks.length+'</span></div>'+tasks+'</div>';
  h+='</div>';
  h+='<div class="modal-foot" style="display:block">';
  h+='<input class="input" id="newTask" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ..." style="margin-bottom:10px">';
  h+='<div class="row" style="margin-bottom:10px"><select class="input" id="newPri"><option value="high">È´ò</option><option value="medium" selected>‰∏≠</option><option value="low">‰Ωé</option></select><input type="date" class="input" id="newDate"></div>';
  h+='<button class="btn btn-primary" style="width:100%" onclick="addTask(\''+el.id+'\')">'+I.plus+' ËøΩÂä†</button>';
  h+='</div></div></div>';
  return h;
}

function openEl(ci,ei){S.selEl={ci:ci,ei:ei};render();}
function closeEl(e){if(e&&e.target!==e.currentTarget)return;S.selEl=null;render();}
function saveElName(ci,ei,v){saveHist();S.data.categories[ci].elements[ei].name=v;save();}
function saveElMemo(ci,ei,v){saveHist();S.data.categories[ci].elements[ei].memo=v;save();}

function toggleTask(elId,tId){
  saveHist();
  for(var c=0;c<S.data.categories.length;c++){
    for(var e=0;e<S.data.categories[c].elements.length;e++){
      var el=S.data.categories[c].elements[e];
      if(el.id===elId){
        for(var t=0;t<el.tasks.length;t++){
          if(el.tasks[t].id===tId){
            el.tasks[t].completed=!el.tasks[t].completed;
            el.tasks[t].completedAt=el.tasks[t].completed?new Date().toISOString().split('T')[0]:null;
          }
        }
      }
    }
  }
  save();
  // ÈÄ≤ÊçóË°®Á§∫„ÇíÊõ¥Êñ∞
  updateProgressDisplay();
}

function updateProgressDisplay(){
  // GOAL„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈÄ≤ÊçóÊõ¥Êñ∞
  var prog=0;
  for(var i=0;i<S.data.categories.length;i++)prog+=calcCatProg(S.data.categories[i]);
  prog=Math.round(prog/8);
  var goalProg=document.querySelector('.goal-progress');
  if(goalProg)goalProg.innerHTML='<span>'+prog+'%</span> ÈÅîÊàê';
  var brandSub=document.querySelector('.brand-sub');
  if(brandSub)brandSub.textContent='ÈÅîÊàêÁéá '+prog+'%';
}

function updateReviewProgress(){
  // „É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÈÄ≤ÊçóÊõ¥Êñ∞
  var st=getStats();
  var prog=st.total?Math.round(st.completed/st.total*100):0;
  var progEl=document.getElementById('review-progress');
  if(progEl){
    progEl.innerHTML='<div style="font-size:36px;font-weight:700;letter-spacing:-0.02em">'+prog+'%</div><div style="font-size:12px;color:var(--text-muted)">ÂÖ®‰ΩìÈÅîÊàêÁéá ('+st.completed+'/'+st.total+')</div>'+(st.overdue?'<div style="font-size:12px;color:var(--danger);margin-top:4px">'+st.overdue+'‰ª∂„ÅÆÊúüÈôêË∂ÖÈÅé</div>':'');
  }
}

function delTask(elId,tId){
  if(!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))return;
  saveHist();
  for(var c=0;c<S.data.categories.length;c++){
    for(var e=0;e<S.data.categories[c].elements.length;e++){
      var el=S.data.categories[c].elements[e];
      if(el.id===elId){
        el.tasks=el.tasks.filter(function(t){return t.id!==tId;});
      }
    }
  }
  save();render();
}

function addTask(elId){
  var title=document.getElementById('newTask').value.trim();
  if(!title)return;
  var pri=document.getElementById('newPri').value;
  var date=document.getElementById('newDate').value||new Date().toISOString().split('T')[0];
  saveHist();
  for(var c=0;c<S.data.categories.length;c++){
    for(var e=0;e<S.data.categories[c].elements.length;e++){
      var el=S.data.categories[c].elements[e];
      if(el.id===elId){
        el.tasks.push({id:'t-'+Date.now(),title:title,priority:pri,dueDate:date,completed:false});
      }
    }
  }
  save();render();
}

// ===== Task List =====
function getAllTasks(){
  var tasks=[];
  for(var c=0;c<S.data.categories.length;c++){
    var cat=S.data.categories[c];
    for(var e=0;e<cat.elements.length;e++){
      var el=cat.elements[e];
      for(var t=0;t<el.tasks.length;t++){
        var task=el.tasks[t];
        tasks.push({id:task.id,title:task.title,priority:task.priority,dueDate:task.dueDate,completed:task.completed,catName:cat.name||'(Êú™Ë®≠ÂÆö)',catIdx:c,elName:el.name||'(Êú™Ë®≠ÂÆö)',elId:el.id,elIdx:e});
      }
    }
  }
  return tasks;
}

function filterTasks(tasks){
  var today=new Date().toISOString().split('T')[0];
  return tasks.filter(function(t){
    if(S.taskFilter==='all')return true;
    if(S.taskFilter==='incomplete')return !t.completed;
    if(S.taskFilter==='completed')return t.completed;
    if(S.taskFilter==='overdue')return !t.completed&&t.dueDate<today;
    return true;
  });
}

function sortTasks(tasks){
  var s=tasks.slice();
  var po={high:0,medium:1,low:2};
  if(S.taskSort==='dueDate'){
    s.sort(function(a,b){
      if(a.completed!==b.completed)return a.completed?1:-1;
      return a.dueDate.localeCompare(b.dueDate);
    });
  }else if(S.taskSort==='category'){
    s.sort(function(a,b){
      if(a.catIdx!==b.catIdx)return a.catIdx-b.catIdx;
      return a.dueDate.localeCompare(b.dueDate);
    });
  }else if(S.taskSort==='priority'){
    s.sort(function(a,b){
      if(a.completed!==b.completed)return a.completed?1:-1;
      var pa=po[a.priority]||2,pb=po[b.priority]||2;
      if(pa!==pb)return pa-pb;
      return a.dueDate.localeCompare(b.dueDate);
    });
  }
  return s;
}

function renderTaskList(){
  if(!S.taskList)return '';
  var all=getAllTasks();
  var filtered=filterTasks(all);
  var sorted=sortTasks(filtered);
  var today=new Date().toISOString().split('T')[0];
  var total=all.length,done=all.filter(function(t){return t.completed}).length;
  var overdue=all.filter(function(t){return !t.completed&&t.dueDate<today}).length;

  var h='<div class="overlay" onclick="closeTasks(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">„Çø„Çπ„ÇØ‰∏ÄË¶ß</div><div class="modal-sub">'+total+'‰ª∂ / ÂÆå‰∫Ü '+done+'‰ª∂'+(overdue?' / <span style="color:var(--danger)">Ë∂ÖÈÅé '+overdue+'‰ª∂</span>':'')+'</div></div><button class="modal-close" onclick="closeTasks()">'+I.x+'</button></div>';
  h+='<div style="padding:10px 20px;border-bottom:1px solid var(--border)">';
  h+='<div class="chips"><span class="chip-label">Ë°®Á§∫</span>';
  h+='<button class="chip'+(S.taskFilter==='all'?' active':'')+'" onclick="setFilter(\'all\')">ÂÖ®„Å¶</button>';
  h+='<button class="chip'+(S.taskFilter==='incomplete'?' active':'')+'" onclick="setFilter(\'incomplete\')">Êú™ÂÆå‰∫Ü</button>';
  h+='<button class="chip'+(S.taskFilter==='completed'?' active':'')+'" onclick="setFilter(\'completed\')">ÂÆå‰∫Ü</button>';
  h+='<button class="chip'+(S.taskFilter==='overdue'?' active':'')+'" onclick="setFilter(\'overdue\')" style="'+(S.taskFilter!=='overdue'?'color:var(--danger)':'')+'">Ë∂ÖÈÅé</button></div>';
  h+='<div class="chips"><span class="chip-label">‰∏¶Êõø</span>';
  h+='<button class="chip'+(S.taskSort==='dueDate'?' active':'')+'" onclick="setSort(\'dueDate\')">ÊúüÈôê</button>';
  h+='<button class="chip'+(S.taskSort==='category'?' active':'')+'" onclick="setSort(\'category\')">„Ç´„ÉÜ„Ç¥„É™</button>';
  h+='<button class="chip'+(S.taskSort==='priority'?' active':'')+'" onclick="setSort(\'priority\')">ÂÑ™ÂÖàÂ∫¶</button></div></div>';
  h+='<div class="modal-body" style="max-height:50vh">';
  if(!sorted.length){
    h+='<div class="empty"><div class="empty-icon">‚úì</div><div class="empty-text">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
  }else{
    var lastCat=null;
    for(var i=0;i<sorted.length;i++){
      var t=sorted[i];
      var ps=priStyle(t.priority);
      var od=!t.completed&&t.dueDate<today;
      if(S.taskSort==='category'&&lastCat!==t.catIdx){
        lastCat=t.catIdx;
        h+='<div style="background:'+S.colors[t.catIdx].center+';color:white;padding:6px 12px;margin:0 -20px;font-size:12px;font-weight:500">'+t.catName+'</div>';
      }
      h+='<div class="task"><input type="checkbox" class="task-check"'+(t.completed?' checked':'')+' onchange="toggleTaskList(\''+t.elId+'\',\''+t.id+'\')"><div class="task-body"><div class="task-name'+(t.completed?' done':'')+'">'+t.title+'</div><div class="task-meta"><span style="color:'+S.colors[t.catIdx].center+'">'+t.catName+'</span><span>'+t.elName+'</span><span class="priority p-'+t.priority+'"><span class="priority-dot"></span>'+ps.l+'</span><span style="'+(od?'color:var(--danger)':'')+'">'+t.dueDate+'</span></div></div><button type="button" class="task-del" onclick="event.stopPropagation();delTaskList(\''+t.elId+'\',\''+t.id+'\')">'+I.trash+'</button></div>';
    }
  }
  h+='</div></div></div>';
  return h;
}

function openTasks(){S.taskList=true;render();}
function closeTasks(e){if(e&&e.target!==e.currentTarget)return;S.taskList=false;render();}
function setFilter(f){S.taskFilter=f;render();}
function setSort(s){S.taskSort=s;render();}
function toggleTaskList(elId,tId){toggleTask(elId,tId);}
function delTaskList(elId,tId){delTask(elId,tId);}

// ===== Category Memo =====
function renderCatMemo(){
  if(S.catMemo===null)return '';
  var ci=S.catMemo;
  var cat=S.data.categories[ci];
  var col=S.colors[ci];
  var today=new Date().toISOString().split('T')[0];
  var total=0,done=0;
  for(var i=0;i<cat.elements.length;i++){
    total+=cat.elements[i].tasks.length;
    for(var t=0;t<cat.elements[i].tasks.length;t++)if(cat.elements[i].tasks[t].completed)done++;
  }

  var h='<div class="overlay" onclick="closeCatMemo(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head" style="background:'+col.center+'"><div><div class="modal-title" style="color:white">'+(cat.name||'„Ç´„ÉÜ„Ç¥„É™')+'</div><div class="modal-sub" style="color:rgba(255,255,255,0.8)">'+done+'/'+total+' ÂÆå‰∫Ü</div></div><button class="btn" style="background:rgba(255,255,255,0.2);border:none;color:white;margin-right:8px" onclick="S.catMemo=null;clickCat('+ci+')">Á∑®ÈõÜ</button><button class="modal-close" style="color:white" onclick="closeCatMemo()">'+I.x+'</button></div>';
  h+='<div class="modal-body" style="max-height:60vh">';

  for(var i=0;i<cat.elements.length;i++){
    var el=cat.elements[i];
    var p=calcProg(el.tasks);
    var pc=progColor(p);
    var d=el.tasks.filter(function(t){return t.completed}).length;
    h+='<div class="el-card" style="border-color:'+pc.bg+'">';
    h+='<div class="el-head" onclick="openElFromCat('+ci+','+i+')" style="background:'+pc.bg+'">';
    h+='<span class="el-name" style="color:'+pc.text+'">'+(el.name||'(Êú™Ë®≠ÂÆö)')+'</span>';
    h+='<span class="el-pct">'+p+'% ('+d+'/'+el.tasks.length+')</span></div>';
    if(el.memo)h+='<div class="el-memo">'+el.memo+'</div>';
    if(el.tasks.length){
      h+='<div class="el-tasks">';
      for(var t=0;t<el.tasks.length;t++){
        var task=el.tasks[t];
        var ps=priStyle(task.priority);
        var od=!task.completed&&task.dueDate<today;
        var st=task.completed?'text-decoration:line-through;color:var(--text-muted)':'';
        h+='<div class="mini-task"><input type="checkbox" class="mini-check"'+(task.completed?' checked':'')+' onchange="toggleTask(\''+el.id+'\',\''+task.id+'\')"><span style="flex:1;'+st+'">'+task.title+'</span><span style="color:'+ps.c+';font-size:10px">‚óè</span><span style="font-size:10px;color:'+(od?'var(--danger)':'var(--text-muted)')+'">'+task.dueDate.slice(5)+'</span></div>';
      }
      h+='</div>';
    }
    h+='</div>';
  }
  h+='</div></div></div>';
  return h;
}

function openCatMemo(ci){S.catMemo=ci;render();}
function closeCatMemo(e){if(e&&e.target!==e.currentTarget)return;S.catMemo=null;render();}
function openElFromCat(ci,ei){S.catMemo=null;S.selEl={ci:ci,ei:ei};render();}

// ===== Today Dashboard =====
function renderToday(){
  if(!S.today)return '';
  var today=new Date().toISOString().split('T')[0];
  var d3=new Date(Date.now()+3*86400000).toISOString().split('T')[0];
  var overdue=[],todayT=[],soon=[],high=[];

  for(var c=0;c<S.data.categories.length;c++){
    var cat=S.data.categories[c];
    for(var e=0;e<cat.elements.length;e++){
      var el=cat.elements[e];
      for(var t=0;t<el.tasks.length;t++){
        var task=el.tasks[t];
        if(task.completed)continue;
        var info={id:task.id,title:task.title,priority:task.priority,dueDate:task.dueDate,catName:cat.name||'(Êú™Ë®≠ÂÆö)',catIdx:c,elName:el.name||'(Êú™Ë®≠ÂÆö)',elId:el.id};
        if(task.dueDate<today)overdue.push(info);
        else if(task.dueDate===today)todayT.push(info);
        else if(task.dueDate<=d3)soon.push(info);
        if(task.priority==='high'&&task.dueDate>=today)high.push(info);
      }
    }
  }

  var sortD=function(a,b){return a.dueDate.localeCompare(b.dueDate);};
  overdue.sort(sortD);todayT.sort(sortD);soon.sort(sortD);high.sort(sortD);

  var now=new Date();
  var dateStr=now.getFullYear()+'Âπ¥'+(now.getMonth()+1)+'Êúà'+now.getDate()+'Êó•';

  var h='<div class="overlay" onclick="closeToday(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">‰ªäÊó•„ÇÑ„Çã„Åì„Å®</div><div class="modal-sub">'+dateStr+'</div></div><button class="modal-close" onclick="closeToday()">'+I.x+'</button></div>';
  h+='<div class="modal-body" style="max-height:60vh">';

  h+='<div class="stats">';
  h+='<div class="stat stat-danger"><div class="stat-val">'+overdue.length+'</div><div class="stat-label">ÊúüÈôêË∂ÖÈÅé</div></div>';
  h+='<div class="stat stat-warning"><div class="stat-val">'+todayT.length+'</div><div class="stat-label">‰ªäÊó•</div></div>';
  h+='<div class="stat stat-info"><div class="stat-val">'+soon.length+'</div><div class="stat-label">3Êó•‰ª•ÂÜÖ</div></div>';
  h+='<div class="stat stat-success"><div class="stat-val">'+high.length+'</div><div class="stat-label">È´òÂÑ™ÂÖàÂ∫¶</div></div>';
  h+='</div>';

  if(overdue.length){h+='<div class="section"><div class="section-head"><span class="section-title" style="color:var(--danger)">ÊúüÈôêË∂ÖÈÅé</span><span class="section-badge" style="background:#fee2e2;color:var(--danger)">'+overdue.length+'</span></div>'+renderTodayTasks(overdue,true)+'</div>';}
  if(todayT.length){h+='<div class="section"><div class="section-head"><span class="section-title" style="color:var(--warning)">‰ªäÊó•</span><span class="section-badge" style="background:#fef3c7;color:var(--warning)">'+todayT.length+'</span></div>'+renderTodayTasks(todayT,false)+'</div>';}
  if(soon.length){h+='<div class="section"><div class="section-head"><span class="section-title" style="color:#2563eb">3Êó•‰ª•ÂÜÖ</span><span class="section-badge" style="background:#eff6ff;color:#2563eb">'+soon.length+'</span></div>'+renderTodayTasks(soon,false)+'</div>';}
  if(high.length){h+='<div class="section"><div class="section-head"><span class="section-title" style="color:var(--success)">È´òÂÑ™ÂÖàÂ∫¶</span><span class="section-badge" style="background:#f0fdf4;color:var(--success)">'+high.length+'</span></div>'+renderTodayTasks(high,false)+'</div>';}

  if(!overdue.length&&!todayT.length&&!soon.length&&!high.length){
    h+='<div class="empty"><div class="empty-icon">üéâ</div><div class="empty-text">Áõ¥Ëøë„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
  }
  h+='</div></div></div>';
  return h;
}

function renderTodayTasks(tasks,od){
  var h='';
  for(var i=0;i<tasks.length;i++){
    var t=tasks[i];
    var ps=priStyle(t.priority);
    h+='<div class="task" style="'+(od?'background:#fef2f2':'')+'"><input type="checkbox" class="task-check" onchange="toggleTask(\''+t.elId+'\',\''+t.id+'\')"><div class="task-body"><div class="task-name">'+t.title+'</div><div class="task-meta"><span style="color:'+S.colors[t.catIdx].center+'">'+t.catName+'</span><span>'+t.elName+'</span></div></div><div style="text-align:right"><span class="priority p-'+t.priority+'"><span class="priority-dot"></span>'+ps.l+'</span><div style="font-size:11px;color:'+(od?'var(--danger)':'var(--text-muted)')+'">'+t.dueDate+'</div></div></div>';
  }
  return h;
}

function openToday(){S.today=true;render();}
function closeToday(e){if(e&&e.target!==e.currentTarget)return;S.today=false;render();}

// ===== Review =====
function getStats(){
  var now=new Date();
  var thisM=now.toISOString().slice(0,7);
  var lastM=new Date(now.getFullYear(),now.getMonth()-1,1).toISOString().slice(0,7);
  var today=now.toISOString().split('T')[0];
  var st={total:0,completed:0,overdue:0,thisMonth:{total:0,completed:0},lastMonth:{total:0,completed:0},byCat:[],byPri:{high:{t:0,c:0},medium:{t:0,c:0},low:{t:0,c:0}}};

  for(var c=0;c<S.data.categories.length;c++){
    var cat=S.data.categories[c];
    var cs={name:cat.name||'(Êú™Ë®≠ÂÆö)',t:0,c:0,col:S.colors[c].center};
    for(var e=0;e<cat.elements.length;e++){
      for(var t=0;t<cat.elements[e].tasks.length;t++){
        var task=cat.elements[e].tasks[t];
        st.total++;cs.t++;st.byPri[task.priority].t++;
        if(task.completed){st.completed++;cs.c++;st.byPri[task.priority].c++;}
        else if(task.dueDate<today)st.overdue++;
        if(task.dueDate.slice(0,7)===thisM){st.thisMonth.total++;if(task.completed)st.thisMonth.completed++;}
        if(task.dueDate.slice(0,7)===lastM){st.lastMonth.total++;if(task.completed)st.lastMonth.completed++;}
      }
    }
    st.byCat.push(cs);
  }
  return st;
}

function renderReviewModal(){
  if(!S.review)return '';
  var st=getStats();
  var now=new Date();
  var prog=st.total?Math.round(st.completed/st.total*100):0;
  var thisP=st.thisMonth.total?Math.round(st.thisMonth.completed/st.thisMonth.total*100):0;
  var lastP=st.lastMonth.total?Math.round(st.lastMonth.completed/st.lastMonth.total*100):0;

  var h='<div class="overlay" onclick="closeReview(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">ÈÄ≤Êçó</div><div class="modal-sub">'+now.getFullYear()+'Âπ¥'+(now.getMonth()+1)+'Êúà</div></div><button class="modal-close" onclick="closeReview()">'+I.x+'</button></div>';
  h+='<div class="modal-body" style="max-height:60vh">';

  h+='<div id="review-progress" style="background:var(--bg-muted);padding:20px;border-radius:var(--radius);text-align:center;margin-bottom:20px">';
  h+='<div style="font-size:36px;font-weight:700;letter-spacing:-0.02em">'+prog+'%</div>';
  h+='<div style="font-size:12px;color:var(--text-muted)">ÂÖ®‰ΩìÈÅîÊàêÁéá ('+st.completed+'/'+st.total+')</div>';
  if(st.overdue)h+='<div style="font-size:12px;color:var(--danger);margin-top:4px">'+st.overdue+'‰ª∂„ÅÆÊúüÈôêË∂ÖÈÅé</div>';
  h+='</div>';

  h+='<div class="stats" style="grid-template-columns:1fr 1fr;margin-bottom:20px">';
  h+='<div class="stat"><div class="stat-val">'+thisP+'%</div><div class="stat-label">‰ªäÊúà ('+st.thisMonth.completed+'/'+st.thisMonth.total+')</div></div>';
  h+='<div class="stat"><div class="stat-val">'+lastP+'%</div><div class="stat-label">ÂÖàÊúà ('+st.lastMonth.completed+'/'+st.lastMonth.total+')</div></div>';
  h+='</div>';

  h+='<div class="section"><div class="section-head"><span class="section-title">„Ç´„ÉÜ„Ç¥„É™Âà•</span></div>';
  for(var i=0;i<st.byCat.length;i++){
    var c=st.byCat[i];
    var cp=c.t?Math.round(c.c/c.t*100):0;
    h+='<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span style="font-weight:500">'+c.name+'</span><span style="color:var(--text-muted)">'+cp+'% ('+c.c+'/'+c.t+')</span></div><div class="progress"><div class="progress-bar" style="width:'+cp+'%;background:'+c.col+'"></div></div></div>';
  }
  h+='</div>';

  h+='<div class="section"><div class="section-head"><span class="section-title">„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</span></div>';
  h+=renderMilestones();
  h+='</div>';

  h+='</div></div></div>';
  return h;
}

function renderMilestones(){
  var h='';
  var cm=new Date().toISOString().slice(0,7);
  var ms=S.milestones.filter(function(m){return m.month===cm;});
  h+='<div style="margin-bottom:10px"><input class="input" id="newMs" placeholder="Êñ∞„Åó„ÅÑÊúàÈñìÁõÆÊ®ô..." style="margin-bottom:8px"><button class="btn btn-primary" style="width:100%" onclick="addMs()">'+I.plus+' ËøΩÂä†</button></div>';
  if(!ms.length){
    h+='<div class="empty" style="padding:16px"><div class="empty-text">‰ªäÊúà„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>';
  }else{
    for(var i=0;i<ms.length;i++){
      var m=ms[i];
      h+='<div class="milestone'+(m.completed?' done':'')+'"><input type="checkbox" class="task-check"'+(m.completed?' checked':'')+' onchange="toggleMs(\''+m.id+'\')"><span class="milestone-name'+(m.completed?' completed':'')+'">'+m.title+'</span>'+(m.completed?'<span>üéâ</span>':'')+'<button type="button" class="task-del" onclick="event.stopPropagation();delMs(\''+m.id+'\')">'+I.trash+'</button></div>';
    }
  }
  return h;
}

function openReview(){S.review=true;render();}
function closeReview(e){if(e&&e.target!==e.currentTarget)return;S.review=false;render();}

function addMs(){
  var v=document.getElementById('newMs').value.trim();
  if(!v)return;
  S.milestones.push({id:'ms-'+Date.now(),title:v,month:new Date().toISOString().slice(0,7),completed:false});
  save();render();
}
function toggleMs(id){
  for(var i=0;i<S.milestones.length;i++){
    if(S.milestones[i].id===id){
      S.milestones[i].completed=!S.milestones[i].completed;
      S.milestones[i].completedAt=S.milestones[i].completed?new Date().toISOString().split('T')[0]:null;
      if(S.milestones[i].completed)setTimeout(function(){alert('üéâ „Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÅîÊàêÔºÅ');},100);
      break;
    }
  }
  save();
  // ÈÄ≤ÊçóÈÉ®ÂàÜ„Å†„ÅëÊõ¥Êñ∞
  updateReviewProgress();
}
function delMs(id){
  if(!confirm('„Åì„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))return;
  S.milestones=S.milestones.filter(function(m){return m.id!==id;});
  save();render();
}

// ===== ÊúàÂà•ÈÅîÊàêÂ±•Ê≠¥ =====
function getMonthlyHistory(){
  var history={};
  // „Çø„Çπ„ÇØ„ÅÆÂÆå‰∫ÜÂ±•Ê≠¥„ÇíÂèéÈõÜ
  for(var c=0;c<S.data.categories.length;c++){
    var cat=S.data.categories[c];
    for(var e=0;e<cat.elements.length;e++){
      var el=cat.elements[e];
      for(var t=0;t<el.tasks.length;t++){
        var task=el.tasks[t];
        if(task.completed&&task.completedAt){
          var month=task.completedAt.slice(0,7);
          if(!history[month])history[month]={tasks:[],milestones:[]};
          history[month].tasks.push({
            title:task.title,
            date:task.completedAt,
            category:cat.name||'(Êú™Ë®≠ÂÆö)',
            element:el.name||'(Êú™Ë®≠ÂÆö)'
          });
        }
      }
    }
  }
  // „Éû„Ç§„É´„Çπ„Éà„Éº„É≥„ÅÆÂÆå‰∫ÜÂ±•Ê≠¥„ÇíÂèéÈõÜ
  for(var i=0;i<S.milestones.length;i++){
    var ms=S.milestones[i];
    if(ms.completed&&ms.completedAt){
      var month=ms.completedAt.slice(0,7);
      if(!history[month])history[month]={tasks:[],milestones:[]};
      history[month].milestones.push({
        title:ms.title,
        date:ms.completedAt
      });
    }
  }
  // Êó•‰ªò„Åß„ÇΩ„Éº„Éà
  for(var m in history){
    history[m].tasks.sort(function(a,b){return a.date.localeCompare(b.date);});
    history[m].milestones.sort(function(a,b){return a.date.localeCompare(b.date);});
  }
  return history;
}

function renderHistoryModal(){
  if(!S.history)return '';
  var hist=getMonthlyHistory();
  var months=Object.keys(hist).sort().reverse();
  var now=new Date();
  
  var h='<div class="overlay" onclick="closeHistory(event)"><div class="modal modal-lg" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">ÈÅîÊàêÂ±•Ê≠¥</div><div class="modal-sub">ÊúàÂà•„ÅÆÈÅîÊàêË®òÈå≤</div></div><button class="modal-close" onclick="closeHistory()">'+I.x+'</button></div>';
  h+='<div class="modal-body" style="max-height:65vh">';
  
  if(months.length===0){
    h+='<div class="empty"><div class="empty-icon">üìÖ</div><div class="empty-text">„Åæ„Å†ÈÅîÊàêÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åô„Çã„Å®Ë®òÈå≤„Åï„Çå„Åæ„Åô</div></div>';
  }else{
    for(var i=0;i<months.length;i++){
      var m=months[i];
      var data=hist[m];
      var year=m.slice(0,4);
      var mon=parseInt(m.slice(5,7));
      var totalCount=data.tasks.length+data.milestones.length;
      
      h+='<div class="history-month">';
      h+='<div class="history-month-head"><span class="history-month-title">'+year+'Âπ¥'+mon+'Êúà</span><span class="section-badge">'+totalCount+'‰ª∂ÈÅîÊàê</span></div>';
      
      // „Éû„Ç§„É´„Çπ„Éà„Éº„É≥
      if(data.milestones.length){
        for(var j=0;j<data.milestones.length;j++){
          var ms=data.milestones[j];
          h+='<div class="history-item history-milestone"><span class="history-icon">üèÜ</span><div class="history-content"><span class="history-title">'+ms.title+'</span><span class="history-date">'+ms.date.slice(5).replace('-','/')+'</span></div></div>';
        }
      }
      
      // „Çø„Çπ„ÇØ
      if(data.tasks.length){
        for(var j=0;j<data.tasks.length;j++){
          var task=data.tasks[j];
          h+='<div class="history-item"><span class="history-icon">‚úì</span><div class="history-content"><span class="history-title">'+task.title+'</span><span class="history-meta">'+task.category+' / '+task.element+'</span></div><span class="history-date">'+task.date.slice(5).replace('-','/')+'</span></div>';
        }
      }
      h+='</div>';
    }
  }
  
  h+='</div></div></div>';
  return h;
}

function openHistory(){S.history=true;render();}
function closeHistory(e){if(e&&e.target!==e.currentTarget)return;S.history=false;render();}
function renderMatrixModal(){
  if(!S.matrix)return '';
  var today=new Date().toISOString().split('T')[0];
  var w7=new Date(Date.now()+7*86400000).toISOString().split('T')[0];
  var q={q1:[],q2:[],q3:[],q4:[]};

  for(var c=0;c<S.data.categories.length;c++){
    var cat=S.data.categories[c];
    for(var e=0;e<cat.elements.length;e++){
      var el=cat.elements[e];
      for(var t=0;t<el.tasks.length;t++){
        var task=el.tasks[t];
        if(task.completed)continue;
        var urgent=task.dueDate<=w7;
        var important=task.priority==='high';
        var info={id:task.id,title:task.title,dueDate:task.dueDate,od:task.dueDate<today,elId:el.id};
        if(urgent&&important)q.q1.push(info);
        else if(!urgent&&important)q.q2.push(info);
        else if(urgent&&!important)q.q3.push(info);
        else q.q4.push(info);
      }
    }
  }

  var h='<div class="overlay" onclick="closeMatrix(event)"><div class="modal modal-xl" onclick="event.stopPropagation()">';
  h+='<div class="modal-head"><div><div class="modal-title">Á∑äÊÄ•Â∫¶√óÈáçË¶ÅÂ∫¶„Éû„Éà„É™„ÇØ„Çπ</div><div class="modal-sub">Á∑äÊÄ•=1ÈÄ±Èñì‰ª•ÂÜÖ / ÈáçË¶Å=È´òÂÑ™ÂÖàÂ∫¶</div></div><button class="modal-close" onclick="closeMatrix()">'+I.x+'</button></div>';
  h+='<div class="modal-body">';

  h+='<div class="matrix">';
  h+='<div class="quadrant q1"><div class="quadrant-head"><span class="quadrant-title">‰ªä„Åô„Åê„ÇÑ„Çã</span><span class="quadrant-count">'+q.q1.length+'</span></div><div class="quadrant-sub">Á∑äÊÄ• & ÈáçË¶Å</div>'+renderQTasks(q.q1)+'</div>';
  h+='<div class="quadrant q2"><div class="quadrant-head"><span class="quadrant-title">Ë®àÁîª„Åô„Çã</span><span class="quadrant-count">'+q.q2.length+'</span></div><div class="quadrant-sub">ÈùûÁ∑äÊÄ• & ÈáçË¶Å</div>'+renderQTasks(q.q2)+'</div>';
  h+='<div class="quadrant q3"><div class="quadrant-head"><span class="quadrant-title">Âßî‰ªª„Åô„Çã</span><span class="quadrant-count">'+q.q3.length+'</span></div><div class="quadrant-sub">Á∑äÊÄ• & ÈùûÈáçË¶Å</div>'+renderQTasks(q.q3)+'</div>';
  h+='<div class="quadrant q4"><div class="quadrant-head"><span class="quadrant-title">Ê§úË®é„Åô„Çã</span><span class="quadrant-count">'+q.q4.length+'</span></div><div class="quadrant-sub">ÈùûÁ∑äÊÄ• & ÈùûÈáçË¶Å</div>'+renderQTasks(q.q4)+'</div>';
  h+='</div>';

  h+='</div></div></div>';
  return h;
}

function renderQTasks(tasks){
  if(!tasks.length)return '<div style="text-align:center;color:var(--text-muted);font-size:11px;padding:16px">„Çø„Çπ„ÇØ„Å™„Åó</div>';
  var h='';
  var max=5;
  for(var i=0;i<Math.min(tasks.length,max);i++){
    var t=tasks[i];
    h+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px"><input type="checkbox" style="width:13px;height:13px" onchange="toggleTask(\''+t.elId+'\',\''+t.id+'\')"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+t.title+'</span><span style="color:'+(t.od?'var(--danger)':'var(--text-muted)')+';font-size:10px">'+t.dueDate.slice(5)+'</span></div>';
  }
  if(tasks.length>max)h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:4px">+'+(tasks.length-max)+'‰ª∂</div>';
  return h;
}

function openMatrix(){S.matrix=true;render();}
function closeMatrix(e){if(e&&e.target!==e.currentTarget)return;S.matrix=false;render();}

// ===== Actions =====
function toggleEdit(){S.editing=!S.editing;render();}
function loadSample(){
  if(confirm('„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü')){
    saveHist();S.data=sampleData();save();render();
  }
}
function resetAll(){
  if(confirm('„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')){
    saveHist();S.data=emptyData();
    S.colors=JSON.parse(JSON.stringify(defaultColors));
    S.centerColor=JSON.parse(JSON.stringify(defaultCenter));
    save();render();
  }
}

// ===== Init =====
document.addEventListener('keydown',function(e){
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();if(histStack.length)undo();}
});

// Auth state listener
auth.onAuthStateChanged(async function(user) {
  currentUser = user;
  authLoading = false;
  
  if (user) {
    // Try to load from cloud first
    var cloudLoaded = await loadFromCloud();
    if (!cloudLoaded) {
      // If no cloud data, load from local
      load();
      // Save local data to cloud
      saveToCloud();
    }
  } else {
    // Not logged in - load from local storage for now
    load();
  }
  
  render();
});

// Handle redirect result (for mobile Google login)
auth.getRedirectResult().then(function(result) {
  if (result.user) {
    console.log('Redirect login successful');
  }
}).catch(function(e) {
  console.error('Redirect error:', e);
  if (e.code !== 'auth/no-auth-event') {
    // Show error only if it's not just "no redirect happened"
    authLoading = false;
    render();
    setTimeout(function() {
      showAuthError('Google„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }, 100);
  }
});

// Initial render (loading state)
render();
</script>
</body>
</html>
